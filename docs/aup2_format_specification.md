# AviUtl2 プロジェクトファイル (.aup2) フォーマット仕様書

**解析対象**: `samples/AviUtl2_sample_project_file_1.aup2`
**作成日**: 2025-12-25
**ステータス**: Draft v0.3

---

## 1. 概要

### 1.1 ファイル形式

- **エンコーディング**: UTF-8（BOMなし）✅ 確認済
- **形式**: INI風テキストフォーマット
- **改行コード**: CRLF (`\r\n`) ✅ 確認済
- **構文**: `[セクション名]` + `キー=値` の組み合わせ

### 1.2 全体構造

```
[project]           # グローバルメタデータ（1個）
[scene.N]           # シーン設定（N=0,1,2...）
[ObjectID]          # タイムラインオブジェクト（0,1,2...）
[ObjectID.EffectID] # オブジェクトに付属するエフェクト（0.0, 0.1, ...）
```

---

## 2. セクション詳細

### 2.1 [project] セクション

プロジェクト全体のメタデータ。ファイル先頭に1つだけ存在。

| キー | 型 | 説明 | サンプル値 |
|------|-----|------|-----------|
| `version` | int | AviUtl2バージョン番号 | `2001901` |
| `file` | string | プロジェクトファイルの絶対パス | `C:\Users\...\project.aup2` |
| `display.scene` | int | 現在表示中のシーン番号 | `0` |

### 2.2 [scene.N] セクション

シーンごとの設定。N はシーン番号（0始まり）。

| キー | 型 | 説明 | サンプル値 |
|------|-----|------|-----------|
| `scene` | int | シーン番号 | `0` |
| `name` | string | シーン名 | `Root` |
| `video.width` | int | 横解像度（ピクセル） | `1920` |
| `video.height` | int | 縦解像度（ピクセル） | `1080` |
| `video.rate` | int | フレームレート（FPS） | `30` |
| `video.scale` | int | ビデオスケール | `1` |
| `audio.rate` | int | オーディオサンプルレート（Hz） | `44100` |
| `cursor.frame` | int | カーソルのフレーム位置 | `864` |
| `cursor.layer` | int | カーソルのレイヤー位置 | `3` |
| `display.frame` | int | 表示開始フレーム | `0` |
| `display.layer` | int | 表示開始レイヤー | `0` |
| `display.zoom` | int | ズーム倍率（10000=100%?） | `10000` |
| `display.order` | int | 表示順序 | `0` |
| `display.camera` | string | カメラ設定（空の場合あり） | `` |
| `display.grid.x` | string | X軸グリッド設定 | `16,-16` |
| `display.grid.y` | string | Y軸グリッド設定 | `16,-16` |
| `display.grid.width` | int | グリッド幅 | `200` |
| `display.grid.height` | int | グリッド高さ | `200` |
| `display.grid.step` | float | グリッドステップ | `200.000000` |
| `display.grid.range` | float | グリッド範囲 | `10000.000000` |
| `display.tempo.bpm` | float | テンポ（BPM） | `120.000000` |
| `display.tempo.beat` | int | 拍子 | `4` |
| `display.tempo.offset` | float | テンポオフセット | `0.000000` |

### 2.3 [ObjectID] セクション

タイムライン上のオブジェクト。ObjectIDは連番（0, 1, 2, ...）。

| キー | 型 | 説明 | サンプル値 |
|------|-----|------|-----------|
| `layer` | int | レイヤー番号（0始まり、大きいほど上） | `0` |
| `frame` | string | フレーム範囲「開始,終了」 | `0,299` |
| `focus` | int | フォーカス状態（省略可、1=選択中） | `1` |

**フレーム計算例**:
- `frame=0,299` かつ `video.rate=30` の場合
- 継続時間 = (299 - 0 + 1) / 30 = 10秒

### 2.4 [ObjectID.EffectID] セクション

オブジェクトに付属するエフェクト/コンポーネント。

- **ObjectID.0**: 通常はメインエフェクト（動画ファイル、テキスト、図形など）
- **ObjectID.1**: 通常は描画設定（標準描画、映像再生など）
- **ObjectID.2以降**: 追加フィルタ効果

共通プロパティ:

| キー | 型 | 説明 |
|------|-----|------|
| `effect.name` | string | エフェクト種別名 |

---

## 3. エフェクト種別

### 3.1 メディアオブジェクト

#### 3.1.1 動画ファイル

```ini
[0.0]
effect.name=動画ファイル
再生位置=0.000,0.000,再生範囲,0
再生速度=100.00
ファイル=
トラック=0
ループ再生=0
音声付き=0
YUV=
```

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `再生位置` | string | 再生位置設定（複合値） |
| `再生速度` | float | 再生速度（100.00=等速） |
| `ファイル` | string | 動画ファイルパス |
| `トラック` | int | トラック番号 |
| `ループ再生` | int | ループ再生（0/1） |
| `音声付き` | int | 音声を含むか（0/1） |
| `YUV` | string | YUV設定 |

#### 3.1.2 画像ファイル

```ini
[5.0]
effect.name=画像ファイル
ファイル=
表示番号=0
連番ファイル=0
```

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `ファイル` | string | 画像ファイルパス |
| `表示番号` | int | 表示番号 |
| `連番ファイル` | int | 連番ファイルか（0/1） |

#### 3.1.3 音声ファイル

```ini
[7.0]
effect.name=音声ファイル
再生位置=0.000,0.000,再生範囲,0
再生速度=100.00
ファイル=
トラック=0
ループ再生=0
```

### 3.2 図形オブジェクト

#### 3.2.1 図形

```ini
[1.0]
effect.name=図形
図形の種類=円
サイズ=100
縦横比=0.00
ライン幅=4000
色=ffffff
角を丸くする=0
```

| プロパティ | 型 | 説明 | 有効値 |
|-----------|-----|------|--------|
| `図形の種類` | string | 図形タイプ | 背景, 円, 四角形, 三角形, 五角形, 六角形, 星型, ハート |
| `サイズ` | int | サイズ | |
| `縦横比` | float | 縦横比 | |
| `ライン幅` | int | 線の太さ | |
| `色` | hex | 色（RGB、#なし） | `ffffff`, `00ff00` |
| `角を丸くする` | int | 角丸め（0/1） | |

### 3.3 テキストオブジェクト

```ini
[2.0]
effect.name=テキスト
サイズ=40.00
字間=0.00
行間=0.00
表示速度=0.00
フォント=Yu Gothic UI
文字色=ffffff
影・縁色=000000
文字装飾=標準文字
文字揃え=左寄せ[上]
B=0
I=0
テキスト=複数行の\nテキスト
文字毎に個別オブジェクト=0
自動スクロール=0
移動座標上に表示=0
オブジェクトの長さを自動調節=0
```

| プロパティ | 型 | 説明 | 有効値 |
|-----------|-----|------|--------|
| `サイズ` | float | フォントサイズ | |
| `字間` | float | 文字間隔 | |
| `行間` | float | 行間隔 | |
| `表示速度` | float | 表示速度 | |
| `フォント` | string | フォント名 | |
| `文字色` | hex | 文字色 | |
| `影・縁色` | hex | 影/縁取り色 | |
| `文字装飾` | string | 装飾タイプ | 標準文字, 影付き文字, 影付き文字(薄), 縁取り文字, 縁取り文字(細), 縁取り文字(太), 縁取り文字(角) |
| `文字揃え` | string | 文字揃え | 下記参照 |
| `B` | int | 太字（0/1） | |
| `I` | int | 斜体（0/1） | |
| `テキスト` | string | テキスト本文（\nで改行） | |

**文字揃えの値**:
- 横書き: `左寄せ[上]`, `左寄せ[中]`, `左寄せ[下]`, `中央揃え[上]`, `中央揃え[中]`, `中央揃え[下]`, `右寄せ[上]`, `右寄せ[中]`, `右寄せ[下]`
- 縦書き: `縦書 上寄[右]`, `縦書 上寄[中]`, `縦書 上寄[左]`, `縦書 中央[右]`, `縦書 中央[中]`, `縦書 中央[左]`, `縦書 下寄[右]`, `縦書 下寄[中]`, `縦書 下寄[左]`

### 3.4 描画設定エフェクト

#### 3.4.1 標準描画

```ini
[1.1]
effect.name=標準描画
X=0.00
Y=0.00
Z=0.00
Group=1
中心X=0.00
中心Y=0.00
中心Z=0.00
X軸回転=0.00
Y軸回転=0.00
Z軸回転=0.00
拡大率=100.000
縦横比=0.000
透明度=0.00
合成モード=通常
```

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| `X`, `Y`, `Z` | float | 座標 |
| `Group` | int | グループ番号 |
| `中心X`, `中心Y`, `中心Z` | float | 回転中心 |
| `X軸回転`, `Y軸回転`, `Z軸回転` | float | 回転角度（度） |
| `拡大率` | float | 拡大率（100=100%） |
| `縦横比` | float | 縦横比 |
| `透明度` | float | 透明度（0=不透明、100=透明?） |
| `合成モード` | string | ブレンドモード |

**合成モード**:
通常, 加算, 減算, 乗算, スクリーン, オーバーレイ, 比較(明), 比較(暗), 輝度, 色差, 陰影, 明暗, 差分

#### 3.4.2 映像再生

動画ファイルオブジェクト用の描画設定。標準描画と同様のプロパティ + `音量`。

```ini
[0.1]
effect.name=映像再生
...
音量=100.00
```

#### 3.4.3 音声再生

音声ファイルオブジェクト用。

```ini
[7.1]
effect.name=音声再生
音量=100.00
左右=0.00
```

### 3.5 フィルタエフェクト

オブジェクトに追加できるフィルタ効果。

#### 3.5.1 グラデーション

```ini
effect.name=グラデーション
強さ=100.0
中心X=0.0
中心Y=0.0
Group=1
角度=0.00
幅=100
合成モード=通常
形状=線形
開始色=ff0000
終了色=0000ff
```

#### 3.5.2 レンズブラー

```ini
effect.name=レンズブラー
範囲=5
光の強さ=32.0
形状=円
サイズ固定=0
```

#### 3.5.3 ライト

```ini
effect.name=ライト
強さ=100.0
拡散=25
比率=0.0
逆光=0
色=ffffff
```

#### 3.5.4 拡散光

```ini
effect.name=拡散光
強さ=50.0
拡散=12
サイズ固定=0
```

#### 3.5.5 波紋

```ini
effect.name=波紋
中心X=0.0
中心Y=0.0
Group=1
幅=30.0
高さ=15.0
速度=150.0
波紋数=0
波紋間隔=0
増幅減衰回数=0
```

#### 3.5.6 シャープ

```ini
effect.name=シャープ
強さ=50.0
範囲=5
```

### 3.6 フィルタエフェクト一覧（全82種）

`AllFiltersAndMovements.aup2` より確認済みの全フィルタ：

#### 色調整（6種）
- 色調補正、グラデーション、単色化、特定色域変換、拡張色設定

#### クリッピング（4種）
- クリッピング、斜めクリッピング、扇クリッピング、マスク

#### ぼかし（5種）
- ぼかし、レンズブラー、放射ブラー、方向ブラー、境界ぼかし

#### 光効果（6種）
- グロー、発光、閃光、拡散光、ライト、色ずれ

#### 装飾（4種）
- 縁取り、枠線、ドロップシャドウ、凸エッジ

#### 抽出（4種）
- クロマキー、ルミナンスキー、カラーキー、エッジ抽出

#### 変形（11種）
- 波紋、ラスター、極座標変換、ディスプレイスメントマップ、リサイズ
- 立方体(カメラ制御)、球体(カメラ制御)、簡易変形、簡易変形(カメラ制御)、万華鏡

#### 加工（5種）
- シャープ、ノイズ除去、インターレース解除、ノイズ、モザイク

#### オフスクリーン（1種）
- オフスクリーン描画

#### 配置（8種）
- 画像ループ、オブジェクト分割、座標の拡大縮小(個別オブジェクト)
- 座標の回転(個別オブジェクト)、円形配置、ランダム配置、ミラー

#### 切り替え効果（12種）
- フェード、ワイプ、画面外から登場、ランダム方向から登場
- 拡大縮小して登場、ランダム間隔で落ちながら登場、弾んで登場
- 広がって登場、起き上がって登場、何処からともなく登場、点滅して登場

#### アニメーション効果（10種）
- 振動、スクリプト制御、震える、振り子、弾む、反復移動
- 砕け散る、点滅、リール回転、粒子化

#### カメラ制御（2種）
- 材質設定(カメラ制御)、カメラ制御オプション

#### 基本効果（6種）
- 座標、拡大率、透明度、回転、領域拡張、反転

---

## 4. 構造パターン

### 4.1 オブジェクトの典型構造

```
[ObjectID]           # オブジェクトヘッダー
  layer=N
  frame=start,end

[ObjectID.0]         # メインエフェクト（動画ファイル/テキスト/図形など）
  effect.name=...
  ...

[ObjectID.1]         # 描画設定（標準描画/映像再生/音声再生）
  effect.name=...
  ...

[ObjectID.2]         # （オプション）フィルタ1
[ObjectID.3]         # （オプション）フィルタ2
...
```

### 4.2 サンプルファイルの構造図

```
Layer 0: [0]動画(0-299) → [1]図形(300-599) → [2]テキスト(622-702) → [3]テキスト(703-783) → [4]テキスト+フィルタ(784-864)
Layer 1: [5]画像(0-299) → [6]図形(300-599)
Layer 2: [7]音声(0-299) → [8]テキスト(300-599)
Layer 3: [9]テキスト(0-299) → [10]テキスト(300-599)
```

---

## 5. アニメーション（モーション）

### 5.1 基本構文

静的な値:
```ini
X=0.00
```

アニメーション値:
```ini
X=開始値,終了値,移動タイプ,パラメータ
```

### 5.2 移動タイプ一覧（全10種）

`AllFiltersAndMovements.aup2` より確認済みの全移動タイプ：

| 移動タイプ | 構文例 | 説明 |
|-----------|--------|------|
| 移動無し | `X=0.00` | 静的値（アニメーションなし） |
| 直線移動 | `X=-100.00,100.00,直線移動,0` | 線形補間 |
| 直線移動(時間制御) | `X=-100.00,100.00,直線移動(時間制御),0\|制御点...` | ベジェ曲線で速度制御 |
| 補間移動 | `X=-100.00,100.00,補間移動,3` | スプライン補間 |
| 補間移動(時間制御) | `X=-100.00,100.00,補間移動(時間制御),0\|制御点...` | ベジェ曲線で速度制御 |
| ランダム移動 | `X=-100.00,100.00,ランダム移動,4\|15` | ランダムな値 |
| 瞬間移動 | `X=-100.00,100.00,瞬間移動,0` | 最終フレームで瞬間的に移動 |
| 移動量指定 | `X=-100.00,10.00,移動量指定,4` | 1フレームあたりの移動量を指定 |
| 反復移動 | `X=0.00,100.00,反復移動,4\|15` | 往復運動 |
| 回転 | `X=0.00,0.00,回転,4\|360` | 円周上の移動 |

#### 5.2.1 直線移動

最もシンプルな線形補間。

```ini
X=-100.00,100.00,直線移動,0
```

| 要素 | 説明 |
|-----|------|
| `-100.00` | 開始値 |
| `100.00` | 終了値 |
| `直線移動` | 移動タイプ |
| `0` | パラメータ（0=デフォルト） |

#### 5.2.2 直線移動(時間制御)

ベジェ曲線で速度を制御する直線移動。

```ini
X=-100.00,100.00,直線移動(時間制御),0|0,0.250712,0.101952,0.749288,1,0.726496,0.416891,0.709402
```

パラメータ形式: `0|始点X,始点Y,制御点1X,制御点1Y,終点X,終点Y,制御点2X,制御点2Y`

#### 5.2.3 反復移動

往復運動。

```ini
X=0.00,100.00,反復移動,4|15
```

パラメータ形式: `タイプ|回数`

| 要素 | 説明 |
|-----|------|
| `4` | イージングタイプ |
| `15` | 反復回数 |

#### 5.2.4 回転

円周上の移動。座標の回転移動に使用。

```ini
X=0.00,0.00,回転,4|360
```

パラメータ形式: `タイプ|角度`

| 要素 | 説明 |
|-----|------|
| `4` | イージングタイプ |
| `360` | 回転角度（度） |

#### 5.2.5 移動量指定

1フレームあたりの移動量を指定。

```ini
X=-100.00,10.00,移動量指定,4
```

| 要素 | 説明 |
|-----|------|
| `-100.00` | 開始位置 |
| `10.00` | 1フレームあたりの移動量 |

### 5.3 複合アニメーション例

**回転しながらフェードアウト**:
```ini
Z軸回転=0.00,3600.00,直線移動,0    # 10回転
拡大率=100.000,10.000,直線移動,0   # 100%→10%に縮小
透明度=0.00,100.00,直線移動,0      # 不透明→透明
```

### 5.4 静的値との混在

同一オブジェクト内で静的値とアニメーション値を混在可能:

```ini
X=669.67                              # 静的（アニメーションなし）
Y=-168.00                             # 静的
Z軸回転=0.00,3600.00,直線移動,0      # アニメーション
```

---

## 6. エスケープ規則

### 6.1 テキスト内のエスケープシーケンス

| シーケンス | 意味 |
|-----------|------|
| `\n` | 改行 |
| `\\` | バックスラッシュ（リテラル） |

### 6.2 エスケープ不要な文字

以下の文字はテキスト値内でそのまま使用可能:

- `[` `]` - 角括弧
- `=` - 等号
- `/` - スラッシュ
- `!"#$%&'()@`+;:*{}<>?_` - その他の記号

**検証結果** (`SpecialChars.aup2`):
```ini
テキスト=左鍵括弧：[\n右鍵括弧：]\n半角等号：=\nスラッシュ：/\nバックスラッシュ：\\\nその他：!"#$%&'()@`+;:*{}<>?_\n
```

### 6.3 パーサー実装上の注意

- `=` は最初の出現で key/value を分割（value内の`=`はそのまま）
- `[` `]` は行頭でセクションヘッダーとして解釈、それ以外は通常文字
- 複数行テキストは `\n` で表現（実際の改行ではない）

---

## 7. 最小プロジェクト構造

`EmptyProject.aup2` より、オブジェクトなしの最小構成:

```ini
[project]
version=2001901
file=C:\path\to\project.aup2
display.scene=0
[scene.0]
scene=0
name=Root
video.width=1920
video.height=1080
video.rate=30
video.scale=1
audio.rate=44100
cursor.frame=0
cursor.layer=0
display.frame=0
display.layer=0
display.zoom=10000
display.order=0
display.camera=
display.grid.x=16,-16
display.grid.y=16,-16
display.grid.width=200
display.grid.height=200
display.grid.step=200.000000
display.grid.range=10000.000000
display.tempo.bpm=120.000000
display.tempo.beat=4
display.tempo.offset=0.000000
```

---

## 8. 未確認事項（追加テスト推奨）

### 8.1 基本フォーマット
- [x] エンコーディングの確定 → UTF-8（BOMなし）
- [x] 改行コードの確定 → CRLF
- [ ] 空白の扱い（キー=値の前後にスペースは許容される?）

### 8.2 複数シーン
- [ ] 複数シーンがある場合の構造（[scene.1], [scene.2]など）
- [ ] シーン間でオブジェクトIDは連番か、シーンごとにリセットか

### 8.3 アニメーション詳細
- [x] 基本的なアニメーション構文 → 確認済（セクション5参照）
- [ ] イージングタイプの完全な一覧
- [ ] `再生位置=0.000,0.000,再生範囲,0` の詳細な意味
- [ ] 移動タイプ「加減速移動」「曲線移動」等の構文

### 8.4 グループ機能
- [ ] `Group=1` の意味と使い方
- [ ] オブジェクトのグループ化はどう表現されるか

### 8.5 その他のエフェクト
- [ ] このサンプルに含まれていないエフェクトの一覧
- [ ] カメラ制御、シーン切り替え等の表現

### 8.6 特殊文字
- [x] テキスト内の特殊文字のエスケープ規則 → 確認済（セクション6参照）
- [ ] ファイルパス内の日本語・特殊文字

---

## 9. 変更履歴

| バージョン | 日付 | 内容 |
|-----------|------|------|
| 0.1 | 2025-12-25 | 初版作成（sample_1解析） |
| 0.2 | 2025-12-25 | アニメーション構文、エスケープ規則、最小構造を追加（EmptyProject, ShapeMotionTestProject, SpecialChars解析） |
| 0.3 | 2025-12-26 | フィルタ全82種、移動タイプ全10種を追加（AllFiltersAndMovements解析） |
